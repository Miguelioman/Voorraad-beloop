<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Actuele Voorraad & Omzet — Excel Import</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg:#0d1b2a;        /* donkerblauw achtergrond */
      --panel:#1b263b;     /* panel achtergrond */
      --ink:#e0e6ed;       /* hoofdtekst */
      --muted:#cbd5e1;     /* secundair */
      --line:#415a77;      /* borders */
      --panel-accent:#274060;
      --total:#2a9d8f;
    }
    *{box-sizing:border-box}
    body{
      font-family: Arial, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", sans-serif;
      margin:24px;
      background:var(--bg);
      color:var(--ink);
    }
    h1{margin:0 0 12px}
    h2{margin:24px 0 8px;color:#f1f5f9}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .chipbar{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:14px;background:var(--panel);border:1px solid var(--line);color:var(--ink);font-size:14px;cursor:pointer}
    input[type="file"]{background:var(--panel);color:var(--ink);padding:8px 10px;border-radius:8px;border:1px solid var(--line)}
    label.toggle{display:inline-flex;align-items:center;gap:8px;cursor:pointer;background:var(--panel);padding:8px 10px;border:1px solid var(--line);border-radius:10px}

    table{width:100%;border-collapse:collapse;background:var(--panel);box-shadow:0 2px 6px rgba(0,0,0,.4);border-radius:10px;overflow:hidden}
    th,td{border:1px solid var(--line);padding:10px 12px;text-align:center;color:var(--ink)}
    th{background:var(--panel-accent);position:sticky;top:0}
    tr:nth-child(even){background:#1e3350}
    tr.total-row td{font-weight:700;background:#17334f;border-top:2px solid var(--total)}

    .canvas-wrap{background:var(--panel);padding:12px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.4)}
    canvas{display:block;width:100%;max-width:1800px;height:800px !important;background:var(--panel);border-radius:8px}
    .hint{color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <h1>Actuele Voorraad & Omzet</h1>
  <div class="row">
    <input id="file" type="file" accept=".xlsx,.xls" />
    <label class="toggle"><input type="checkbox" id="showTrend" /> Toon polynomiale trendlijnen</label>
  </div>
  <div id="typeChips" class="chipbar"></div>

  <h2>Overzicht eindvoorraad per producttype</h2>
  <table id="table"><thead></thead><tbody></tbody></table>

  <h2>Verloop eindvoorraad</h2>
  <div class="canvas-wrap">
    <canvas id="chart"></canvas>
    <div class="hint">Tip: klik op een datapunt om de waarde te bekijken. Filter producttypen met de chips bovenaan.</div>
  </div>

  <h2>Omzet per maand per producttype</h2>
  <table id="revenueTable"><thead></thead><tbody></tbody></table>

  <h2>Omzet per producttype over de maanden (stacked)</h2>
  <div class="canvas-wrap">
    <canvas id="revenueStacked"></canvas>
  </div>

<script>
  // === Normalisatie & prijzen ===
  const MAP_SYNONIEMEN = {
    'schoenen': 'Klompen',
    'klompen': 'Klompen',
    'sneakers': 'Sneakers',
    'mokken': 'Mokken',
    'sokken': 'Sokken',
    'compressiesokken': 'Compressiesokken'
  };
  const PRIJZEN = {
    'Sokken': 10.95,
    'Compressiesokken': 29.99,
    'Klompen': 79.99,
    'Sneakers': 99.99,
    'Mokken': 14.95
  };
  function normaliseerType(raw){
    if (!raw) return 'Onbekend';
    const key = String(raw).trim().toLowerCase();
    if (MAP_SYNONIEMEN[key]) return MAP_SYNONIEMEN[key];
    if (/^sok(ken)?$/.test(key)) return 'Sokken';
    if (/^compressie\s*sok(ken)?$/.test(key)) return 'Compressiesokken';
    if (/^schoen(en)?$/.test(key)) return 'Klompen';
    if (/^sneaker(s)?$/.test(key)) return 'Sneakers';
    if (/^mok(ken)?$/.test(key)) return 'Mokken';
    return key.charAt(0).toUpperCase()+key.slice(1);
  }
  function parseNumber(v){
    if (v == null || v === '') return 0;
    if (typeof v === 'number') return v;
    const s = String(v).replace(/\./g,'').replace(',', '.');
    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  }

  // === Excel kolommen detecteren ===
  function detectKolommen(headers){
    const idx = { product: -1, eindvoorraad: -1, verkocht: -1 };
    headers.forEach((h,i)=>{
      const k = String(h||'').trim().toLowerCase();
      if (idx.product === -1 && k === 'product type') idx.product = i;
      if (idx.eindvoorraad === -1 && k === 'ending inventory units') idx.eindvoorraad = i;
      if (idx.verkocht === -1 && k === 'inventory units sold') idx.verkocht = i;
    });
    return idx;
  }

  // === Maanden sorteren o.b.v. sheetnaam ===
  function sortMonths(arr){
    return arr.slice().sort((a,b)=>{
      const da = Date.parse(a+"-01") || Date.parse(a) || 0;
      const db = Date.parse(b+"-01") || Date.parse(b) || 0;
      if (da && db) return da - db; // chronologisch
      return a.localeCompare(b, 'nl'); // fallback alfabetisch
    });
  }

  // === Polynomiale (graad 2) trendlijn ===
  function calcPolyTrend(yValues, degree=2){
    const n = yValues.length;
    const x = Array.from({length:n}, (_,i)=>i+1);
    const X = Array.from({length:n}, (_,i)=> Array.from({length:degree+1}, (_,j)=> Math.pow(x[i], j)));
    const XT = X[0].map((_,c)=>X.map(r=>r[c]));
    const XTX = XT.map(r=>XT[0].map((_,c)=> r.reduce((sum,v,i)=> sum+v*X[i][c],0)));
    const XTY = XT.map(r=> r.reduce((sum,v,i)=> sum+v*yValues[i],0));
    const m = degree+1;
    const A = XTX.map((row,i)=> row.concat([XTY[i]]));
    for(let i=0;i<m;i++){
      let max=i; for(let k=i+1;k<m;k++) if(Math.abs(A[k][i])>Math.abs(A[max][i])) max=k;
      [A[i],A[max]]=[A[max],A[i]];
      for(let k=i+1;k<m;k++){
        const f=A[k][i]/A[i][i];
        for(let j=i;j<=m;j++) A[k][j]-=A[i][j]*f;
      }
    }
    const coeff=new Array(m);
    for(let i=m-1;i>=0;i--){
      let sum=A[i][m];
      for(let j=i+1;j<m;j++) sum-=A[i][j]*coeff[j];
      coeff[i]=sum/A[i][i];
    }
    return x.map(xx=> coeff.reduce((acc,c,j)=> acc + c*Math.pow(xx,j), 0));
  }

  // === State ===
  let months=[]; let types=new Set();
  let voorraadPivot={}; // { maand: { type: eindvoorraad } }
  let omzetPivot={};    // { maand: { type: omzetEUR } }
  let chartInstance=null;      // lijngrafiek eindvoorraad
  let revenueStackedChart=null; // stacked omzet

  // === Elementen ===
  const $file=document.getElementById('file');
  const $typeChips=document.getElementById('typeChips');
  const $showTrend=document.getElementById('showTrend');
  const $tableHead=document.querySelector('#table thead');
  const $tableBody=document.querySelector('#table tbody');
  const $revHead=document.querySelector('#revenueTable thead');
  const $revBody=document.querySelector('#revenueTable tbody');

  // === Bestandsupload en verwerken ===
  $file.addEventListener('change', async (e)=>{
    const file=e.target.files?.[0];
    if(!file) return;
    const buf=await file.arrayBuffer();
    const wb=XLSX.read(buf,{type:'array'});

    // reset
    months=[]; types=new Set(); voorraadPivot={}; omzetPivot={};

    wb.SheetNames.forEach(sheetName=>{
      const ws=wb.Sheets[sheetName];
      const json=XLSX.utils.sheet_to_json(ws,{header:1,defval:null,raw:true});
      if(!json.length) return;
      const headers=json[0];
      const idx=detectKolommen(headers);
      if(idx.product===-1 || idx.eindvoorraad===-1) return; // noodzakelijke kolommen

      const maand=sheetName;
      if(!months.includes(maand)) months.push(maand);
      if(!voorraadPivot[maand]) voorraadPivot[maand] = {};
      if(!omzetPivot[maand]) omzetPivot[maand] = {};

      for(let r=1;r<json.length;r++){
        const row=json[r];
        const t=normaliseerType(row[idx.product]);
        const eind=parseNumber(row[idx.eindvoorraad]);
        const verkocht = idx.verkocht>=0 ? parseNumber(row[idx.verkocht]) : 0;

        types.add(t);
        voorraadPivot[maand][t]=(voorraadPivot[maand][t]||0)+eind;
        const prijs=PRIJZEN[t]||0;
        omzetPivot[maand][t]=(omzetPivot[maand][t]||0)+verkocht*prijs;
      }
    });

    months=sortMonths(months);

    buildTypeFilters();
    renderTable();
    renderRevenueTable();
    renderInventoryChart();
    renderRevenueStackedChart();
  });

  // === Filters ===
  function buildTypeFilters(){
    $typeChips.innerHTML='';
    Array.from(types).sort().forEach(t=>{
      const id=`t-${t.replace(/[^a-z0-9]+/gi,'-')}`;
      const label=document.createElement('label');
      label.className='chip';
      label.innerHTML=`<input id="${id}" type="checkbox" checked> ${t}`;
      label.querySelector('input').addEventListener('change',()=>{
        renderTable();
        renderRevenueTable();
        renderInventoryChart();
        renderRevenueStackedChart();
      });
      $typeChips.appendChild(label);
    });
  }
  function getSelectedTypes(){
    return Array.from($typeChips.querySelectorAll('input:checked'))
      .map(cb=>cb.nextSibling.textContent.trim());
  }

  // === Tabellen ===
  function renderTable(){
    const selected=getSelectedTypes();
    $tableHead.innerHTML='';
    const trh=document.createElement('tr');
    trh.innerHTML='<th>Producttype</th>'+months.map(m=>`<th>${m}</th>`).join('');
    $tableHead.appendChild(trh);
    $tableBody.innerHTML='';
    selected.forEach(t=>{
      const tds=months.map(m=>`<td>${(voorraadPivot[m]?.[t]??0)}</td>`).join('');
      $tableBody.insertAdjacentHTML('beforeend',`<tr><td>${t}</td>${tds}</tr>`);
    });
  }
  function formatEUR(v){
    try{ return v.toLocaleString('nl-NL',{style:'currency',currency:'EUR',minimumFractionDigits:2}); }
    catch{ return `€${(Math.round(v*100)/100).toFixed(2)}`; }
  }
  function renderRevenueTable(){
    const selected=getSelectedTypes();
    $revHead.innerHTML='';
    const trh=document.createElement('tr');
    trh.innerHTML='<th>Producttype</th>'+months.map(m=>`<th>${m}</th>`).join('');
    $revHead.appendChild(trh);
    $revBody.innerHTML='';

    // Regels per geselecteerd producttype
    selected.forEach(t=>{
      const tds=months.map(m=>{
        const omzet=omzetPivot[m]?.[t]??0;
        const total=Object.values(omzetPivot[m]||{}).reduce((a,b)=>a+b,0);
        const perc= total>0 ? ((omzet/total)*100).toFixed(1)+'%' : '-';
        return `<td>${formatEUR(omzet)}<br><small>${perc}</small></td>`;
      }).join('');
      $revBody.insertAdjacentHTML('beforeend',`<tr><td>${t}</td>${tds}</tr>`);
    });

    // Totaalregel per maand (altijd totale omzet, ongeacht selectie)
    const totalTds = months.map(m=>{
      const total = Object.values(omzetPivot[m]||{}).reduce((a,b)=>a+b,0);
      return `<td><strong>${formatEUR(total)}</strong></td>`;
    }).join('');
    $revBody.insertAdjacentHTML('beforeend',`<tr class="total-row"><td>Totaal</td>${totalTds}</tr>`);
  }

  // === Grafieken ===
  function renderInventoryChart(){
    const ctx=document.getElementById('chart').getContext('2d');
    const selected=getSelectedTypes();
    const palette=['#8ecae6','#ffb703','#fb8500','#ff006e','#06d6a0','#ffd166','#ef476f','#118ab2'];

    const datasets = selected.map((t,i)=>({
      label:t,
      data: months.map(m=> (voorraadPivot[m]?.[t]??0)),
      borderColor: palette[i % palette.length],
      backgroundColor: palette[i % palette.length],
      borderWidth: 2,
      pointRadius: 4,
      pointHoverRadius: 6,
      tension: .2
    }));

    if ($showTrend.checked){
      selected.forEach((t,i)=>{
        const values=months.map(m=> (voorraadPivot[m]?.[t]??0));
        const trend=calcPolyTrend(values,2);
        datasets.push({
          label: t+" trend",
          data: trend,
          borderColor: palette[i % palette.length],
          borderDash:[6,6],
          borderWidth: 2,
          pointRadius: 0,
          fill:false,
          tension: 0
        });
      });
    }

    if(chartInstance) chartInstance.destroy();
    chartInstance = new Chart(ctx, {
      type:'line',
      data:{ labels: months, datasets },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        interaction:{ mode:'nearest', intersect:true },
        plugins:{
          legend:{ position:'bottom', labels:{ color:'#e0e6ed', font:{ size:18, weight:'600' }, boxWidth:16, boxHeight:16 }},
          tooltip:{ enabled:true, titleFont:{size:16}, bodyFont:{size:16} }
        },
        scales:{
          x:{ ticks:{ color:'#e0e6ed', font:{ size:16 }}, title:{ display:true, text:'Maand', color:'#e0e6ed', font:{ size:18, weight:'600' }}, grid:{ color:'rgba(65,90,119,.3)'} },
          y:{ ticks:{ color:'#e0e6ed', font:{ size:16 }}, title:{ display:true, text:'Eindvoorraad', color:'#e0e6ed', font:{ size:18, weight:'600' }}, grid:{ color:'rgba(65,90,119,.3)'} }
        },
        onClick:(evt)=>{
          const points = chartInstance.getElementsAtEventForMode(evt,'nearest',{intersect:true},true);
          if(points.length){
            const p = points[0];
            chartInstance.tooltip.setActiveElements([p], {x: p.element.x, y: p.element.y});
            chartInstance.update();
          }
        }
      }
    });
  }

  function renderRevenueStackedChart(){
    const ctx=document.getElementById('revenueStacked').getContext('2d');
    const selected=getSelectedTypes();
    const palette=['#8ecae6','#ffb703','#fb8500','#ff006e','#06d6a0','#ffd166','#ef476f','#118ab2'];

    const datasets = selected.map((t,i)=>({
      label:t,
      data: months.map(m=> (omzetPivot[m]?.[t]??0)),
      backgroundColor: palette[i % palette.length],
      borderColor: palette[i % palette.length]
    }));

    if(revenueStackedChart) revenueStackedChart.destroy();
    revenueStackedChart = new Chart(ctx, {
      type:'bar',
      data:{ labels: months, datasets },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{ position:'bottom', labels:{ color:'#e0e6ed', font:{ size:18, weight:'600' }, boxWidth:16, boxHeight:16, padding:18 }},
          tooltip:{
            enabled:true,
            titleFont:{size:16}, bodyFont:{size:16},
            callbacks:{
              label:(context)=>{
                const value = context.parsed.y || 0;
                const monthIdx = context.dataIndex;
                const maand = months[monthIdx];
                const total = selected.reduce((s,t)=> s + ((omzetPivot[maand]?.[t])||0), 0);
                const perc = total>0 ? (value/total*100).toFixed(1) : 0;
                const label = context.dataset.label || '';
                return `${label}: ${formatEUR(value)} (${perc}%)`;
              }
            }
          }
        },
        scales:{
          x:{
            stacked:true,
            ticks:{ color:'#e0e6ed', font:{ size:16 }},
            grid:{ color:'rgba(65,90,119,.25)' }
          },
          y:{
            stacked:true,
            ticks:{ color:'#e0e6ed', font:{ size:16 }, callback:(v)=> v>=1000? v.toLocaleString('nl-NL'): v },
            title:{ display:true, text:'Omzet (EUR)', color:'#e0e6ed', font:{ size:18, weight:'600' }},
            grid:{ color:'rgba(65,90,119,.25)' }
          }
        }
      }
    });
  }

  // Toggle trendlines (alleen voor lijngrafiek)
  $showTrend.addEventListener('change', ()=>{ renderInventoryChart(); });
</script>
</body>
</html>
